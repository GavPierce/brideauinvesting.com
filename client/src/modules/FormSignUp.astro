---
import { SITE_TITLE } from '../app/constants';
---

<div class="w-full flex flex-col items-center justify-center px-6 pt-8 mx-auto pt:mt-0 dark:bg-gray-900">
	<div class="flex items-center justify-center mb-8 text-2xl font-semibold lg:mb-10 dark:text-white">
		<span>{SITE_TITLE}</span>
	</div>

	<!-- Invalid / loading state -->
	<div id="invite-loading" class="w-full max-w-md p-6 sm:p-8 bg-white rounded-xl shadow-lg dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-center">
		<p class="text-gray-500 dark:text-gray-400">Validating invite link...</p>
	</div>

	<div id="invite-invalid" class="hidden w-full max-w-md p-6 sm:p-8 bg-white rounded-xl shadow-lg dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-center">
		<svg class="mx-auto h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
		</svg>
		<h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Invalid Invite</h2>
		<p class="text-gray-500 dark:text-gray-400 mb-4" id="invite-error-msg">This invite link is invalid or has expired.</p>
		<a href="/authentication/sign-in" class="text-blue-600 hover:underline dark:text-blue-400 text-sm">Go to sign in</a>
	</div>

	<!-- Signup form -->
	<div id="signup-card" class="hidden w-full max-w-md p-6 space-y-6 sm:p-8 bg-white rounded-xl shadow-lg dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
		<h2 class="text-2xl font-bold text-gray-900 dark:text-white">Create your account</h2>
		<p class="text-sm text-gray-500 dark:text-gray-400">You've been invited to join the platform.</p>
		<div id="signup-error" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-900/30 dark:text-red-400"></div>
		<form id="signup-form" class="space-y-5">
			<div>
				<label for="signup-email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email</label>
				<input type="email" id="signup-email" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="name@company.com" required />
			</div>
			<div>
				<label for="signup-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Display name</label>
				<input type="text" id="signup-name" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Your name" />
			</div>
			<div>
				<label for="signup-password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Password</label>
				<input type="password" id="signup-password" placeholder="••••••••" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required minlength="6" />
			</div>
			<div>
				<label for="signup-confirm" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Confirm password</label>
				<input type="password" id="signup-confirm" placeholder="••••••••" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required minlength="6" />
			</div>
			<button type="submit" id="signup-btn" class="w-full px-5 py-3 text-base font-medium text-center text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 transition-colors">
				Create account
			</button>
			<div class="text-sm font-medium text-gray-500 dark:text-gray-400">
				Already have an account? <a href="/authentication/sign-in" class="text-blue-600 hover:underline dark:text-blue-400">Sign in</a>
			</div>
		</form>
	</div>
</div>

<script>
	import { signup, validateInvite, isLoggedIn } from './auth.client.js';

	if (isLoggedIn()) {
		window.location.href = '/';
	}

	const params = new URLSearchParams(window.location.search);
	const inviteToken = params.get('invite');

	const loadingEl = document.getElementById('invite-loading')!;
	const invalidEl = document.getElementById('invite-invalid')!;
	const cardEl = document.getElementById('signup-card')!;
	const errorMsgEl = document.getElementById('invite-error-msg')!;
	const emailInput = document.getElementById('signup-email') as HTMLInputElement;

	if (!inviteToken) {
		loadingEl.classList.add('hidden');
		invalidEl.classList.remove('hidden');
		errorMsgEl.textContent = 'No invite token provided. You need an invite link to create an account.';
	} else {
		// Validate the invite
		validateInvite(inviteToken).then((result) => {
			loadingEl.classList.add('hidden');
			if (!result.valid) {
				invalidEl.classList.remove('hidden');
				errorMsgEl.textContent = result.error || 'This invite link is invalid or has expired.';
			} else {
				cardEl.classList.remove('hidden');
				if (result.email) {
					emailInput.value = result.email;
					emailInput.readOnly = true;
					emailInput.classList.add('bg-gray-100', 'dark:bg-gray-600', 'cursor-not-allowed');
				}
			}
		});
	}

	const form = document.getElementById('signup-form') as HTMLFormElement;
	const errorEl = document.getElementById('signup-error') as HTMLElement;
	const btn = document.getElementById('signup-btn') as HTMLButtonElement;

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		errorEl.classList.add('hidden');

		const email = emailInput.value;
		const displayName = (document.getElementById('signup-name') as HTMLInputElement).value;
		const password = (document.getElementById('signup-password') as HTMLInputElement).value;
		const confirm = (document.getElementById('signup-confirm') as HTMLInputElement).value;

		if (password !== confirm) {
			errorEl.textContent = 'Passwords do not match';
			errorEl.classList.remove('hidden');
			return;
		}

		btn.disabled = true;
		btn.textContent = 'Creating account...';

		try {
			await signup(inviteToken!, email, password, displayName);
			window.location.href = '/';
		} catch (err: any) {
			errorEl.textContent = err.message || 'Signup failed';
			errorEl.classList.remove('hidden');
			btn.disabled = false;
			btn.textContent = 'Create account';
		}
	});
</script>
